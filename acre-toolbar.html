<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-badge/paper-badge.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="../paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../paper-header-panel/paper-header-panel.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <acre-toolbar></acre-toolbar>

Custom property | Description | Default
----------------|-------------|----------
`--toolbar-container` | Mixin applied to all rows (middle, top, bottom)  | `{}`
`--toolbar-logo` | Mixin applied to the logo  | `{}`
`--toolbar-mobile-logo` | Mixin applied to the logo in mobile view  | `{}`
`--toolbar-top` | Mixin applied to the top area of the toolbar | `{}`
`--top-color` | The color at the top of the bar | `--primary-color`
`--top-text-color` | The text color for the top of the bar | `--primary-text-color`
`--toolbar-middle` | Mixin applied to the middle area of the toolbar | `{}`
`--middle-color` | The color at the middle of the bar | `--primary-color`
`--middle-text-color` | The text color for the middle of the bar | `--primary-text-color`
`--search-input` | Mixin applied to the search input container | `{}`
`--search-bar-color` | The search bar background color | `#fff`
`--search-bar-text-color` | The search bar text color | `#000`
`--product-price-text-color` | The Search bar product price color | `--primary-color`
`--product-name-text-color` | The Search bar product name text color | `--primary-text-color`
`--product-description-text-color` | The product description text color | `--secondary-text-color`
`--toolbar-cart-button` | Mixin applicated to the cart button | `{}`
`--cart-badge-color` | The cart badge color | `--dark-primary-color`
`--cart-badge-text-color` | The cart badge color | `---primary-text-color`
`--toolbar-bottom` | Mixin applied to the bottom area of the toolbar | `{}`
`--bottom-color` | The color at the bottom of the bar | `--primary-color`
`--bottom-text-color` | The text color for the bottom of the bar | `--primary-text-color`
`--menu-item-hover-background-color` | The background color user when the user hover menu item | `#fff`
`--menu-item-hover-text-color` | The color text used when the user hover menu item | `#000`
`--menu-expand-icon` | Mixin applied to the expand icon in the menu bar | `{}`
`--menu-subitems-container` | Mixin applied to the menu item container | `{}`
`--menu-image` | Mixin applied to the menu image | `{}`
`--menu-image-container` | Mixin applied to the menu image container | `{}`
`--dropdown-background-color` | The menu item dropdown background color | `#fff`
`--subitem-text-hover-color` | The color user when the user hover the submenu item | `--primary-color`
`--drawer-color` | The drawer color | `--primary-color`
`--drawer-item-text-color` | The drawer item text color color | `--primary-text-color`

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="acre-toolbar">
    <template>
        <style include="iron-flex iron-flex-alignment" />
        <style>
            :host {
                display: block;
                box-sizing: border-box;
            }

            a,
            a:link,
            a:visited,
            a:hover,
            a:focus,
            a:active {
                color: inherit;
                text-decoration: none;
            }

            .container {
                @apply(--layout-vertical);
            }

            .top,
            .middle,
            .bottom {
                @apply(--layout-horizontal);
                font-size: 12px;
                @apply(--layout-horizontal);
                @apply(--layout-center-justified);
            }
            /**
            * TOP
            */

            .top {
                padding: 10px 10px 5px 10px;
                background-color: var(--top-color, --primary-color);
                color: var(--top-text-color, --primary-text-color);
                @apply(--toolbar-top);
            }

            .top .action {
                padding-left: 15px;
            }

            .top .action:hover {
                cursor: pointer;
            }

            .small-logo {
                width: 90px;
                height: 50px;
                margin-left: 10px;
                @apply(--toolbar-mobile-logo);
            }
            /**
            * Middle
            */

            .middle {
                padding: 0 10px 5px 10px;
                background-color: var(--middle-color, --primary-color);
                color: var(--middle-text-color, --primary-text-color);
                @apply(--layout-center);
                @apply(--toolbar-middle);
            }

            .logo {
                width: 150px;
                height: 40px;
                margin-left: 10px;
                margin-right: 10px;
                @apply(--toolbar-logo);
            }
            /*SEARCH BAR*/

            .search-bar {
                height: 33px;
                border-radius: 0;
                background: var(--search-bar-color, #fff);
                color: var(--search-bar-text-color, #000);
                transition: all 0.3s ease;
                -webkit-transition: all 0.3s ease;
                @apply(--layout-horizontal);
                @apply(--layout-center);
                @apply(--layout-flex);
                @apply(--search-input);
                position: relative;
            }

            .search-button {
                padding-right: 10px;
            }

            .search-input {
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                border: none;
                outline: none;
                padding-left: 10px;
                background: none;
                color: var(--search-bar-text-color, #5a6674);
                @apply(--layout-flex);
            }

            .search-input::-webkit-search-cancel-button {
                -webkit-appearance: none;
                appearance: none;
            }

            .search-bar .search-results {
                min-height: 30px;
                width: 100%;
                position: absolute;
                left: 0;
                top: 100%;
                display: block;
                background-color: white;
                z-index: 10;
                box-shadow: 7px 10px 19px -8px rgba(0, 0, 0, 0.63);
            }

            .search-result {
                padding: 10px;
            }

            .search-result .image {
                height: 70px;
                width: 100px;
                margin-right: 10px;
            }

            .search-result:hover {
                background-color: #F7F7F7;
                cursor: pointer;
            }

            .search-result .name {
                font-weight: bold;
                text-decoration: none;
                color: var(--product-name-text-color, --primary-text-color);
                font-size: 16px;
                font-weight: 400;
                line-height: 24px;
            }

            .search-result .description {
                font-weight: bold;
                color: var(--product-description-text-color, --secondary-text-color);
                font-size: 14px;
                font-weight: 400;
                line-height: 20px;
            }

            .search-result .price {
                font-weight: bold;
                font-size: 25px;
                margin: 0;
                color: var(--product-price-text-color, --primary-color);
            }

            .login paper-button {
                --paper-button: {
                    text-transform: none;
                }
            }

            .cart {
                display: inline-block;
                @apply(--toolbar-cart-button);
            }

            .cart .card-badge {
                font-weight: normal;
                border-radius: 50%;
                margin-left: 5px;
                margin-bottom: 0px;
                background-color: var(--cart-badge-color, --dark-primary-color);
                opacity: 1.0;
                color: var(--cart-badge-text-color, --primary-text-color);
                padding: 3px 7px;
            }
            /**
            * Bottom
            */

            .bottom {
                background-color: var(--bottom-color, --dark-primary-color);
                color: var(--bottom-text-color, --primary-text-color);
                padding: 0;
                margin: 0;
                @apply(--toolbar-bottom);
            }

            .dropmenu {
                margin: 0;
                padding: 0;
            }

            .dropmenu ul {
                margin: 0;
                padding: 0;
            }

            .dropmenu > li {
                float: left;
                list-style: none;
                background-color: var(--bottom-color, --dark-primary-color);
                position: relative;
                padding: 10px;
            }

            .dropmenu > li .menu-item-name {
                text-decoration: none;
                display: block;
                line-height: 25px;
            }

            .dropmenu > li ul {
                display: none;
                position: absolute;
                left: 0;
                top: 100%;
                min-width: 10em;
                box-shadow: 7px 10px 19px -8px rgba(0, 0, 0, 0.63);
                z-index: 999;
            }

            .dropmenu > li ul li {
                float: none;
            }

            .dropmenu > li:hover {
                background: var(--menu-item-hover-background-color, white);
                color: var(--menu-item-hover-text-color, black);
            }

            .dropmenu > li:hover > .menu-item-name {
                display: block;
                color: var(--menu-item-hover-text-color, black);
            }

            .dropmenu > li:hover > ul {
                display: block;
                color: var(--menu-item-hover-text-color, black);
                background: var(--dropdown-background-color, white);
            }

            .dropmenu:after {
                content: "";
                display: table;
                clear: both;
            }

            .expand-icon {
                width: 15px;
                height: 15px;
                @apply(--menu-expand-icon);
            }

            .menu-subitems,
            .menu-display {
                min-height: 200px;
                min-width: 200px;
            }

            .menu-subitems {
                padding: 20px 20px 20px 10px;
                color: var(--subitem-text-color, #636363);
                @apply(--menu-subitems-container);
            }

            .menu-display {
                @apply(--menu-image-container);
            }

            .menu-display iron-image {
                width: 200px;
                @apply(--menu-image);
            }

            .menu-subitem {
                padding: 5px 0;
            }

            .menu-subitem .icon,
            .drawer-subitem .icon {
                width: 14px;
                height: 14px;
                color: var(--dropdown-background-color, white);
            }

            .menu-subitem:hover,
            .menu-subitem:hover > .icon,
            .drawer-item:hover > .name,
            .drawer-item:hover > .expand-icon,
            .drawer-subitem:hover,
            .drawer-subitem:hover .icon {
                cursor: pointer;
                color: var(--subitem-text-hover-color, --primary-color);
            }

            .group-container {
                @apply(--layout-horizontal);
                @apply(--layout-center-justified);
                @apply(--layout-center);
                width: 1200px;
                @apply(--toolbar-container);
            }

            .top.nomobile .group-container {
                @apply(--layout-end-justified);
            }
            /* drawer */

            .drawer {
                font-size: 12px;
            }

            .drawer-header {
                padding: 10px;
                background-color: var(--drawer-color, --primary-color);
                color: white;
                @apply(--layout-horizontal);
                @apply(--layout-justified);
            }

            .drawer .cart {
                border-left: 1px solid;
                border-color: var(--cart-badge-color, --dark-primary-color);
            }

            .drawer-content {
                padding: 10px;
                @apply(--layout-vertical);
            }

            .drawer-item {
                padding: 10px;
                color: var(--drawer-item-text-color, --primary-text-color);
            }

            .drawer-item .name {
                font-size: 14px;
            }

            .drawer-subitem {
                line-height: 27px;
            }

            .drawer-subitems {
                margin-left: 10px;
                padding: 10px;
            }

            @media screen and (max-width: 768px) {
                .nomobile {
                    display: none;
                }
            }

            @media screen and (min-width: 769px) {
                .onlymobile {
                    display: none;
                }
            }
        </style>

        <iron-ajax id="searchRequest" auto url="[[_searchUrl]]" handle-as="json" debounce-duration="300" on-response="_handleSearchResponse" on-request="_handleSearchRequest" on_error="_searchBlur">
        </iron-ajax>

        <paper-drawer-panel force-narrow class="drawer">
            <paper-header-panel drawer>
                <div class="drawer-header">
                    <div class="login">
                        <template is="dom-if" if="{{!loggedUser.name}}" restamp="true">
                            <a href="[[loginUrl]]">
                                <paper-button class="layout horizontal center" style="margin:0">
                                    <iron-icon icon="account-box"></iron-icon>
                                    <span>Entre ou Cadastre-se</span>
                                </paper-button>
                            </a>
                        </template>
                        <template is="dom-if" if="{{loggedUser.name}}" restamp="true">
                            <a href="[[profileUrl]]">
                                <paper-button class="layout horizontal center" style="margin:0">
                                    <iron-icon icon="account-box"></iron-icon>
                                    <span>[[loggedUser.name]]</span>
                                </paper-button>
                            </a>
                        </template>
                    </div>
                    <div class="cart">
                        <a href="[[cartUrl]]">
                            <paper-button class="layout horizontal center" style="margin:0">
                                <iron-icon icon="shopping-cart"></iron-icon>
                                <span class="card-badge">[[cartItemsCount]]</span>
                            </paper-button>
                        </a>
                    </div>
                </div>
                <div class="drawer-content">
                    <template is="dom-repeat" items=[[menuItems]] as=menuItem index-as=index>
                        <div class="drawer-item" on-click="_collapseClick">
                            <span class="name">[[menuItem.name]]</span>
                            <template is="dom-if" if="{{menuItem.subitems}}">
                                <iron-icon class="expand-icon" icon="expand-more"></iron-icon>
                            </template>
                            <iron-collapse opened="{{_isOpened(_itemOpened, index)}}">
                                <div class="collapse-content">
                                    <template is="dom-if" if="{{menuItem.subitems}}">
                                        <div class="layout horizontal">
                                            <template is="dom-repeat" items=[[menuItem.subitems]] as=subitemArray index-as="index">
                                                <div class="drawer-subitems layout flex">
                                                    <template is="dom-repeat" items=[[subitemArray]] as=subitem index-as="index">
                                                        <div class="drawer-subitem layout horizontal flex center">
                                                            <a href="[[subitem.link]]">[[subitem.name]]</a>
                                                            <div class="horizontal end-justified layout flex icon">
                                                                <iron-icon class="icon" icon="chevron-right"></iron-icon>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </iron-collapse>
                        </div>
                    </template>
                </div>
            </paper-header-panel>
            <paper-header-panel main>
                <div class="container">
                    <div class="top onlymobile">
                        <div class="group-container layout horizontal justified">
                            <div class="layout horizontal center">
                              <iron-icon icon="menu" paper-drawer-toggle></iron-icon>
                              <a href="[[logo.link]]">
                                    <iron-image class="small-logo" src="[[logo.image]]" preload sizing="contain"></iron-image>
                              </a>
                            </div>
                            <div class="layout horizontal end-justified">
                            <div class="login">
                                <template is="dom-if" if="{{!loggedUser.name}}" restamp="true">
                                    <a href="[[loginUrl]]">
                                        <paper-button class="layout horizontal center" style="margin:0">
                                            <iron-icon icon="account-box"></iron-icon>
                                            <span>Entre ou Cadastre-se</span>
                                        </paper-button>
                                    </a>
                                </template>
                                <template is="dom-if" if="{{loggedUser.name}}" restamp="true">
                                    <a href="[[profileUrl]]">
                                        <paper-button class="layout horizontal center" style="margin:0">
                                            <iron-icon icon="account-box"></iron-icon>
                                            <span>[[loggedUser.name]]</span>
                                        </paper-button>
                                    </a>
                                </template>
                            </div>
                            <div class="cart">
                                <a href="[[cartUrl]]">
                                    <paper-button class="layout horizontal center" style="margin:0">
                                        <iron-icon icon="shopping-cart"></iron-icon>
                                        <span class="card-badge">[[cartItemsCount]]</span>
                                    </paper-button>
                                </a>
                            </div>
                        </div>
                        </div>
                    </div>
                    <div class="top nomobile">
                        <div class="group-container">
                            <template is="dom-repeat" items=[[actions]] as=action index-as="index">
                                <a class="action" href="[[action.link]]">[[action.name]]</a>
                            </template>
                        </div>
                    </div>
                    <div class="middle">
                        <div class="group-container">
                            <a class="nomobile" href="[[logo.link]]">
                                <iron-image class="logo" src="[[logo.image]]" preload sizing="contain"></iron-image>
                            </a>
                            <div class="search-bar">
                                <input class="search-input" is="iron-input" placeholder="Buscar" on-blur="_searchBlur" on-focus="_searchFocus" bind-value="{{query}}" />
                                <iron-icon class="search-button" icon="search"></iron-icon>
                                <template is="dom-if" if="[[_searchResults.length]]" restamp="true">
                                    <div class="search-results">
                                        <template is="dom-repeat" items=[[_searchResults]] as=searchResult>
                                            <div class="search-result horizontal layout">
                                                <template is="dom-if" if={{searchResult.image}}>
                                                    <iron-image class="image" src="[[searchResult.image]]" preload sizing="cover"></iron-image>
                                                </template>
                                                <div class="vertical layout">
                                                    <span class="name">[[searchResult.name]]</span>
                                                    <span class="description">[[searchResult.description]]</span>
                                                    <span class="price">{{_formatPrice(searchResult.price)}}</span>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                            <div class="login nomobile">
                                <template is="dom-if" if="{{!loggedUser.name}}" restamp="true">
                                    <a href="[[loginUrl]]">
                                        <paper-button class="layout horizontal center" style="margin:0">
                                            <iron-icon icon="account-box"></iron-icon>
                                            <span>Entre ou Cadastre-se</span>
                                        </paper-button>
                                    </a>
                                </template>
                                <template is="dom-if" if="{{loggedUser.name}}" restamp="true">
                                    <a href="[[profileUrl]]">
                                        <paper-button class="layout horizontal center" style="margin:0">
                                            <iron-icon icon="account-box"></iron-icon>
                                            <span>[[loggedUser.name]]</span>
                                        </paper-button>
                                    </a>
                                </template>
                            </div>
                            <div class="cart nomobile">
                                <a href="[[cartUrl]]">
                                    <paper-button class="layout horizontal center" style="margin:0">
                                        <iron-icon icon="shopping-cart"></iron-icon>
                                        <span>Carrinho</span>
                                        <span class="card-badge">[[cartItemsCount]]</span>
                                    </paper-button>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="bottom nomobile">
                        <div class="group-container">
                            <ul class="dropmenu">
                                <template is="dom-repeat" items=[[menuItems]] as=menuItem index-as=index>
                                    <li>
                                        <a class="menu-item-name" href="[[menuItem.link]]">
                                          [[menuItem.name]]
                                          <template is="dom-if" if="{{menuItem.subitems}}">
                                            <iron-icon class="expand-icon" icon="expand-more"></iron-icon>
                                          </template>
                                        </a>
                                        <template is="dom-if" if="{{menuItem.subitems}}">
                                            <ul>
                                                <li class="layout horizontal">
                                                    <template is="dom-repeat" items=[[menuItem.subitems]] as=subitemArray index-as="index">
                                                        <div class="menu-subitems layout flex">
                                                            <template is="dom-repeat" items=[[subitemArray]] as=subitem index-as="index">
                                                                <div class="menu-subitem layout horizontal flex">
                                                                    <a href="[[subitem.link]]">[[subitem.name]]</a>
                                                                    <iron-icon class="layout flex icon" icon="chevron-right"></iron-icon>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    <template is="dom-if" if="[[menuItem.cover]]" restamp="true">
                                                        <div class="menu-display vertical layout">
                                                            <iron-image class="flex" src="[[menuItem.cover]]" preload sizing="[[menuItem.coverSizing]]"></iron-image>
                                                        </div>
                                                    </template>
                                                </li>
                                            </ul>
                                        </template>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                    <template is="dom-if" if="[[_searching]]" restamp="true">
                        <paper-progress class="fit" style="width:100%" indeterminate></paper-progress>
                    </template>
                </div>
                <content></content>
            </paper-header-panel>
        </paper-drawer-panel>

    </template>

    <script>
        Polymer({
            is: 'acre-toolbar',

            properties: {
                /**
                 * Describes the logo
                 *
                 * @type {{image: string, link: string}}
                 */
                logo: {
                    type: Object,
                    value: function() {
                        return {}
                    }
                },

                /**
                 * The actions list at the top bar
                 *
                 * @type {[{image: string, link: string}]}
                 */
                actions: {
                    type: Array,
                    value: function() {
                        return []
                    }
                },

                /**
                 * The menu itens with this subitems, this is placed at the bottom bar
                 *
                 * @type {[{
                 * name: string,
                 * link:string,
                 * cover: string,
                 * coverSizing: contain,
                 * subitems: [{name: string, link: string}]
                 * }]}
                 */
                menuItems: {
                    type: Array,
                    value: function() {
                        return []
                    }
                },

                _itemOpened: {
                    type: Number,
                    value: 0,
                    notify: true
                },

                /**
                 * The logged user data
                 *
                 * @type {{name: string}}
                 */
                loggedUser: {
                    type: String,
                    value: function() {
                        return {}
                    }
                },

                /**
                 * The login url
                 */
                loginUrl: {
                    type: String,
                    value: '',
                },

                /**
                 * The profile url
                 */
                profileUrl: {
                    type: String,
                    value: '',
                },

                /**
                 * The cart url
                 */
                cartUrl: {
                    type: String,
                    value: '',
                },

                /**
                 * The cart items count
                 */
                cartItemsCount: {
                    type: Number,
                    value: 0
                },

                searchUrl: {
                    type: String,
                    value: ''
                },

                _searchResults: {
                    type: Array,
                    value: function() {
                        return []
                    }
                },

                _searchUrl: {
                    type: String,
                    computed: '_computeSearchUrl(searchUrl, query)'
                },

                _searching: {
                    type: Boolean,
                    value: false,
                },
            },

            // Element Lifecycle

            ready: function() {
                // `ready` is called after all elements have been configured, but
                // propagates bottom-up. This element's children are ready, but parents
                // are not.
                //
                // This is the point where you should make modifications to the DOM (when
                // necessary), or kick off any processes the element wants to perform.
            },

            attached: function() {
                // `attached` fires once the element and its parents have been inserted
                // into a document.
                //
                // This is a good place to perform any work related to your element's
                // visual state or active behavior (measuring sizes, beginning animations,
                // loading resources, etc).
            },

            detached: function() {
                // The analog to `attached`, `detached` fires when the element has been
                // removed from a document.
                //
                // Use this to clean up anything you did in `attached`.
            },

            // Element Behavior

            //utils
            _formatPrice: function(price) {
                if (!price) return price;
                return "R$" + price.toFixed(2);
            },

            _computeSearchUrl: function(searchUrl, query) {
                if (!query) return "";
                return searchUrl.replace("searchPlaceholder", query);
            },

            _handleSearchRequest: function(e) {
                this._searching = true;
            },

            _handleSearchResponse: function(e) {
                this._searchResults = e.detail.xhr.response;
                this._searching = false;
            },

            _searchBlur: function(e) {
                this._searchResults = [];
                this._searching = false;
            },

            _searchFocus: function(e) {
                if (this.query)
                    this.$.searchRequest.generateRequest();
            },

            _isOpened: function(_itemOpened, index) {
                return _itemOpened == index;
            },

            _collapseClick: function(e) {
                this.set('_itemOpened', e.model.index);
            },

        });
    </script>
</dom-module>
